# 谓词下推测试

测试表

```sql
hive (default)> desc emp;
OK
col_name        data_type       comment
empno                   int                                         
ename                   string                                      
job                     string                                      
mgr                     int                                         
hiredate                string                                      
sal                     double                                      
comm                    double                                      
deptno                  int

hive (default)> desc dept;
OK
col_name        data_type       comment
deptno                  int                                         
dname                   string                                      
loc                     int 
```

执行时间测试

```sql
# 系统自动做谓词下推，当sql很复杂时，可能会失效
hive (default)> select t1.ename,t1.job,t2.dname
              > from emp t1 join dept t2
              > on t1.deptno = t2.deptno
              > where t2.deptno<30;
....
t1.ename        t1.job  t2.dname
SMITH   CLERK   RESEARCH
JONES   MANAGER RESEARCH
CLARK   MANAGER ACCOUNTING
SCOTT   ANALYST RESEARCH
ADAMS   CLERK   RESEARCH
FORD    ANALYST RESEARCH
MILLER  CLERK   ACCOUNTING
Time taken: 35.455 seconds, Fetched: 7 row(s)             
```

```sql
# 自己手动做谓词下推
hive (default)> select t1.ename,t1.job,t2.dname
              > from emp t1 
              > join (select * from dept where deptno<30) t2
              > on t1.deptno = t2.deptno;
....
t1.ename        t1.job  t2.dname
SMITH   CLERK   RESEARCH
JONES   MANAGER RESEARCH
CLARK   MANAGER ACCOUNTING
SCOTT   ANALYST RESEARCH
ADAMS   CLERK   RESEARCH
FORD    ANALYST RESEARCH
MILLER  CLERK   ACCOUNTING
Time taken: 28.477 seconds, Fetched: 7 row(s)              
```

查看执行计划

过滤字段是join的关联字段，是原表字段

```sql
hive (default)> explain select t1.ename,t1.job,t2.dname
              > from emp t1 join dept t2
              > on t1.deptno = t2.deptno
              > where t2.deptno<30;
OK
Explain
STAGE DEPENDENCIES:
  Stage-4 is a root stage
  Stage-3 depends on stages: Stage-4
  Stage-0 depends on stages: Stage-3

STAGE PLANS:
  Stage: Stage-4
    Map Reduce Local Work
      Alias -> Map Local Tables:
        $hdt$_1:t2 
          Fetch Operator
            limit: -1
      Alias -> Map Local Operator Tree:
        $hdt$_1:t2 
          TableScan
            alias: t2
            Statistics: Num rows: 1 Data size: 690 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: (deptno < 30) (type: boolean)  【这里】
              Statistics: Num rows: 1 Data size: 690 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: deptno (type: int), dname (type: string)
                outputColumnNames: _col0, _col1
                Statistics: Num rows: 1 Data size: 690 Basic stats: COMPLETE Column stats: NONE
                HashTable Sink Operator
                  keys:
                    0 _col2 (type: int)
                    1 _col0 (type: int)

  Stage: Stage-3
    Map Reduce
      Map Operator Tree:
          TableScan
            alias: t1
            Statistics: Num rows: 1 Data size: 6560 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: (deptno < 30) (type: boolean)  【这里】
              Statistics: Num rows: 1 Data size: 6560 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: ename (type: string), job (type: string), deptno (type: int)
                outputColumnNames: _col0, _col1, _col2
                Statistics: Num rows: 1 Data size: 6560 Basic stats: COMPLETE Column stats: NONE
                Map Join Operator
                  condition map:
                       Inner Join 0 to 1
                  keys:
                    0 _col2 (type: int)
                    1 _col0 (type: int)
                  outputColumnNames: _col0, _col1, _col4
                  Statistics: Num rows: 1 Data size: 7216 Basic stats: COMPLETE Column stats: NONE
                  Select Operator
                    expressions: _col0 (type: string), _col1 (type: string), _col4 (type: string)
                    outputColumnNames: _col0, _col1, _col2
                    Statistics: Num rows: 1 Data size: 7216 Basic stats: COMPLETE Column stats: NONE
                    File Output Operator
                      compressed: false
                      Statistics: Num rows: 1 Data size: 7216 Basic stats: COMPLETE Column stats: NONE
                      table:
                          input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                          output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                          serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
      Execution mode: vectorized
      Local Work:
        Map Reduce Local Work

  Stage: Stage-0
    Fetch Operator
      limit: -1
      Processor Tree:
        ListSink
```

```sql
hive (default)> explain select t1.ename,t1.job,t2.dname
              > from emp t1 
              > join (select * from dept where deptno<30) t2
              > on t1.deptno = t2.deptno;
OK
Explain
STAGE DEPENDENCIES:
  Stage-4 is a root stage
  Stage-3 depends on stages: Stage-4
  Stage-0 depends on stages: Stage-3

STAGE PLANS:
  Stage: Stage-4
    Map Reduce Local Work
      Alias -> Map Local Tables:
        $hdt$_1:dept 
          Fetch Operator
            limit: -1
      Alias -> Map Local Operator Tree:
        $hdt$_1:dept 
          TableScan
            alias: dept
            Statistics: Num rows: 1 Data size: 690 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: (deptno < 30) (type: boolean)  【这里】
              Statistics: Num rows: 1 Data size: 690 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: deptno (type: int), dname (type: string)
                outputColumnNames: _col0, _col1
                Statistics: Num rows: 1 Data size: 690 Basic stats: COMPLETE Column stats: NONE
                HashTable Sink Operator
                  keys:
                    0 _col2 (type: int)
                    1 _col0 (type: int)

  Stage: Stage-3
    Map Reduce
      Map Operator Tree:
          TableScan
            alias: t1
            Statistics: Num rows: 1 Data size: 6560 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: (deptno < 30) (type: boolean)   【这里】
              Statistics: Num rows: 1 Data size: 6560 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: ename (type: string), job (type: string), deptno (type: int)
                outputColumnNames: _col0, _col1, _col2
                Statistics: Num rows: 1 Data size: 6560 Basic stats: COMPLETE Column stats: NONE
                Map Join Operator
                  condition map:
                       Inner Join 0 to 1
                  keys:
                    0 _col2 (type: int)
                    1 _col0 (type: int)
                  outputColumnNames: _col0, _col1, _col4
                  Statistics: Num rows: 1 Data size: 7216 Basic stats: COMPLETE Column stats: NONE
                  Select Operator
                    expressions: _col0 (type: string), _col1 (type: string), _col4 (type: string)
                    outputColumnNames: _col0, _col1, _col2
                    Statistics: Num rows: 1 Data size: 7216 Basic stats: COMPLETE Column stats: NONE
                    File Output Operator
                      compressed: false
                      Statistics: Num rows: 1 Data size: 7216 Basic stats: COMPLETE Column stats: NONE
                      table:
                          input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                          output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                          serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
      Execution mode: vectorized
      Local Work:
        Map Reduce Local Work

  Stage: Stage-0
    Fetch Operator
      limit: -1
      Processor Tree:
        ListSink

```

过滤字段不是join的关联字段，是原表字段

```sql
hive (default)> explain select t1.ename,t1.job,t2.dname
              > from emp t1 join dept t2
              > on t1.deptno = t2.deptno
              > where t2.dname='ACCOUNTING';
OK
Explain
STAGE DEPENDENCIES:
  Stage-4 is a root stage
  Stage-3 depends on stages: Stage-4
  Stage-0 depends on stages: Stage-3

STAGE PLANS:
  Stage: Stage-4
    Map Reduce Local Work
      Alias -> Map Local Tables:
        $hdt$_1:t2 
          Fetch Operator
            limit: -1
      Alias -> Map Local Operator Tree:
        $hdt$_1:t2 
          TableScan
            alias: t2
            Statistics: Num rows: 1 Data size: 690 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: ((dname = 'ACCOUNTING') and deptno is not null) (type: boolean)  【这里】
              Statistics: Num rows: 1 Data size: 690 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: deptno (type: int)
                outputColumnNames: _col0
                Statistics: Num rows: 1 Data size: 690 Basic stats: COMPLETE Column stats: NONE
                HashTable Sink Operator
                  keys:
                    0 _col2 (type: int)
                    1 _col0 (type: int)

  Stage: Stage-3
    Map Reduce
      Map Operator Tree:
          TableScan
            alias: t1
            Statistics: Num rows: 1 Data size: 6560 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: deptno is not null (type: boolean)  【这里】
              Statistics: Num rows: 1 Data size: 6560 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: ename (type: string), job (type: string), deptno (type: int)
                outputColumnNames: _col0, _col1, _col2
                Statistics: Num rows: 1 Data size: 6560 Basic stats: COMPLETE Column stats: NONE
                Map Join Operator
                  condition map:
                       Inner Join 0 to 1
                  keys:
                    0 _col2 (type: int)
                    1 _col0 (type: int)
                  outputColumnNames: _col0, _col1
                  Statistics: Num rows: 1 Data size: 7216 Basic stats: COMPLETE Column stats: NONE
                  Select Operator
                    expressions: _col0 (type: string), _col1 (type: string), 'ACCOUNTING' (type: string)
                    outputColumnNames: _col0, _col1, _col2
                    Statistics: Num rows: 1 Data size: 7216 Basic stats: COMPLETE Column stats: NONE
                    File Output Operator
                      compressed: false
                      Statistics: Num rows: 1 Data size: 7216 Basic stats: COMPLETE Column stats: NONE
                      table:
                          input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                          output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                          serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
      Execution mode: vectorized
      Local Work:
        Map Reduce Local Work

  Stage: Stage-0
    Fetch Operator
      limit: -1
      Processor Tree:
        ListSink
```

```sql
hive (default)> explain select t1.ename,t1.job,t2.dname
              > from emp t1 
              > join (select * from dept where dname='ACCOUNTING') t2
              > on t1.deptno = t2.deptno;
OK
Explain
STAGE DEPENDENCIES:
  Stage-4 is a root stage
  Stage-3 depends on stages: Stage-4
  Stage-0 depends on stages: Stage-3

STAGE PLANS:
  Stage: Stage-4
    Map Reduce Local Work
      Alias -> Map Local Tables:
        $hdt$_1:dept 
          Fetch Operator
            limit: -1
      Alias -> Map Local Operator Tree:
        $hdt$_1:dept 
          TableScan
            alias: dept
            Statistics: Num rows: 1 Data size: 690 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: ((dname = 'ACCOUNTING') and deptno is not null) (type: boolean) 【这里】
              Statistics: Num rows: 1 Data size: 690 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: deptno (type: int)
                outputColumnNames: _col0
                Statistics: Num rows: 1 Data size: 690 Basic stats: COMPLETE Column stats: NONE
                HashTable Sink Operator
                  keys:
                    0 _col2 (type: int)
                    1 _col0 (type: int)

  Stage: Stage-3
    Map Reduce
      Map Operator Tree:
          TableScan
            alias: t1
            Statistics: Num rows: 1 Data size: 6560 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: deptno is not null (type: boolean)  【这里】
              Statistics: Num rows: 1 Data size: 6560 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: ename (type: string), job (type: string), deptno (type: int)
                outputColumnNames: _col0, _col1, _col2
                Statistics: Num rows: 1 Data size: 6560 Basic stats: COMPLETE Column stats: NONE
                Map Join Operator
                  condition map:
                       Inner Join 0 to 1
                  keys:
                    0 _col2 (type: int)
                    1 _col0 (type: int)
                  outputColumnNames: _col0, _col1
                  Statistics: Num rows: 1 Data size: 7216 Basic stats: COMPLETE Column stats: NONE
                  Select Operator
                    expressions: _col0 (type: string), _col1 (type: string), 'ACCOUNTING' (type: string)
                    outputColumnNames: _col0, _col1, _col2
                    Statistics: Num rows: 1 Data size: 7216 Basic stats: COMPLETE Column stats: NONE
                    File Output Operator
                      compressed: false
                      Statistics: Num rows: 1 Data size: 7216 Basic stats: COMPLETE Column stats: NONE
                      table:
                          input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                          output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                          serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
      Execution mode: vectorized
      Local Work:
        Map Reduce Local Work

  Stage: Stage-0
    Fetch Operator
      limit: -1
      Processor Tree:
        ListSink
```